# =============================================================================
# PR Preview Stale Cleanup
# =============================================================================
#
# Runs weekly to cleanup stale previews.
#
# =============================================================================

name: PR Preview Stale Cleanup

on:
  schedule:
    - cron: "0 7 * * 0" # Every Sunday at 07:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  actions: write

env:
  FLY_ORG: ${{ vars.FLY_ORG || 'personal' }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  list-previews:
    name: List Preview Apps
    runs-on: ubuntu-latest
    outputs:
      previews: ${{ steps.matrix.outputs.previews }}
    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: 0.4.14

      - name: List preview apps and PR info
        id: matrix
        run: |
          echo "Listing Fly apps for org: ${FLY_ORG}"
          APPS_JSON=$(flyctl apps list --json --org "${FLY_ORG}")
          echo "Raw app count: $(echo "$APPS_JSON" | jq length)"

          PREVIEW_APPS=$(echo "$APPS_JSON" | jq -r '.[].Name | select(startswith("metaculus-pr-"))')

          if [ -z "$PREVIEW_APPS" ]; then
            echo "previews=[]" >> $GITHUB_OUTPUT
            echo "No preview apps found"
            exit 0
          fi

          OUT='[]'
          while IFS= read -r APP_NAME; do
            [ -z "$APP_NAME" ] && continue
            PREVIEW_ID="${APP_NAME#metaculus-}"
            PR_NUM=$(echo "$PREVIEW_ID" | sed -n 's/^pr-\([0-9]*\)-.*/\1/p')
            [ -z "$PR_NUM" ] && continue

            PR_JSON=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json headRefName,labels,state 2>/dev/null || echo '{}')
            HEAD_REF=$(echo "$PR_JSON" | jq -r '.headRefName // ""')
            [ -z "$HEAD_REF" ] && continue
            PR_STATE=$(echo "$PR_JSON" | jq -r '.state // ""')
            LABELS=$(echo "$PR_JSON" | jq -r '[.labels[].name] | join(" ") // ""')
            IS_STALE="false"
            if [ "$PR_STATE" != "OPEN" ] || echo "$LABELS" | grep -qw "Stale"; then
              IS_STALE="true"
            fi

            ENTRY=$(jq -n \
              --arg app "$APP_NAME" \
              --arg pr "$PR_NUM" \
              --arg preview_id "$PREVIEW_ID" \
              --arg head_ref "$HEAD_REF" \
              --argjson is_stale "$IS_STALE" \
              '{app: $app, pr_number: $pr, preview_id: $preview_id, head_ref: $head_ref, is_stale: $is_stale}')
            OUT=$(echo "$OUT" | jq --argjson e "$ENTRY" '. + [$e]')
          done <<< "$PREVIEW_APPS"

          echo "previews<<EOF" >> $GITHUB_OUTPUT
          echo "$OUT" | jq -c '.' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found $(echo "$OUT" | jq length) preview(s)"

  cleanup-stale:
    name: Cleanup Stale Previews
    needs: list-previews
    if: needs.list-previews.outputs.previews != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.list-previews.outputs.previews) }}
    steps:
      - name: Trigger cleanup for stale PR
        if: matrix.is_stale == true
        run: |
          gh workflow run pr_preview.yml \
            --repo ${{ github.repository }} \
            -f pr_number=${{ matrix.pr_number }} \
            -f action=cleanup \
            -f cleanup_reason=Stale
          echo "Triggered cleanup for PR #${{ matrix.pr_number }} (${{ matrix.app }})"
