# Generated by Django 5.1.4 on 2024-12-13 14:09

from django.db import migrations, models
from django.db.models import When, Case, Value, Q


def migrate_project_visibility_field(apps, schema_editor):
    """
    Merging `Project.unlisted` and `Post.add_posts_to_main_feed` flags into a new `Post.visibility` enum.

    This change also updates private projects that were using `Project.add_posts_to_main_feed`
    to the `not_in_main_feed` visibility setting - https://github.com/Metaculus/metaculus/pull/1657
    """

    Project = apps.get_model("projects", "Project")
    Project.objects.update(
        visibility=Case(
            # If the post is unlisted, set visibility to UNLISTED
            When(unlisted=True, then=Value("unlisted")),
            # If add_posts_to_main_feed is True and is not private,
            # set visibility to NORMAL
            When(
                Q(add_posts_to_main_feed=True) & Q(default_permission__isnull=False),
                then=Value("normal"),
            ),
            # Otherwise, set visibility to NOT_IN_MAIN_FEED
            default=Value("not_in_main_feed"),
            output_field=models.CharField(),
        )
    )


class Migration(migrations.Migration):
    dependencies = [
        ("projects", "0008_project_description_pt_project_name_pt_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="project",
            name="visibility",
            field=models.CharField(
                choices=[
                    ("normal", "Normal"),
                    ("not_in_main_feed", "Not In Main Feed"),
                    ("unlisted", "Unlisted"),
                ],
                db_index=True,
                default="not_in_main_feed",
                help_text="Sets the visibility of this project.<br><ul><li><strong>Normal</strong> is visible on the main feed, contributes to global leaderboards/medals, and lists the project in the tournaments/question series page.</li><li><strong>Not In Main Feed</strong> is not visible in the main feed, but can be searched for, doesn't contribute to global leaderboards/medals, and lists the project in the tournaments/question series page.</li><li><strong>Unlisted</strong> is not visible in the main feed, not searchable, and doesn't contribute to global leaderboards/medals.</li></ul><br />If this project is not of type <code>site_main</code>, <code>tournament</code>, or <code>question_series</code>, this field should be <strong>Not In Main Feed</strong> to remain neutral.",
            ),
        ),
        migrations.RunPython(
            migrate_project_visibility_field, migrations.RunPython.noop
        ),
    ]
